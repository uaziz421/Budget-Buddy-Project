<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>Budget Buddy</title>
    <link href="style.css" rel="stylesheet" type="text/css" />
  </head>

  <body>
    <div style="text-align: center">
      <img width="300" src="Logos/Logo1.jpeg" alt="Logo1" />
    </div>
    <div class="subheader-container">
      <h2 id="subheaderh2">
        Welcome to Budget Buddy, your favorite accounting web application.
      </h2>
    </div>

    <!-- signin container here is used to center the whole form in the page -->
    <div class="signin-container">
      <!-- the styles for the form class are being applied the label, input and button -->
      <h3 id="subheaderh3">Sign in below</h3>

      <div class="signin-form">
        <label>Username:</label>
        <input type="text" id="signinUsername" />

        <label>Password:</label>
        <input type="password" id="signinPassword" />
        <div class="forgot-password">
          <a href="forgotpassword.html" id="link">Forgot password?</a>
        </div>
        <input type="submit" id="signin" value="Sign In" />

        <div class="create-new-user-container">
          <div>Don't have an Account?</div>
          <a href="signup.html">
            <button id="create-user-btn">Create New User</button>
          </a>
        </div>
      </div>
    </div>

    <!-- admin login container-->
    <div class="adminloginbutton-container">
      <div>Are you an administrator? 
        <a href="administrator_login.html">
          <button id="adminlogincontainer-button">Sign in here</button>
        </a>
      </div>
    </div>

    <script type="module">
      // Import the functions you need from the SDKs you need
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
      import {
        getDatabase,
        set,
        get,
        update,
        remove,
        ref,
        child,
      } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";
      import {
        getAuth,
        setPersistence,
        signInWithEmailAndPassword,
        browserSessionPersistence,
        updateProfile,
      } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
      // TODO: Add SDKs for Firebase products that you want to use
      // https://firebase.google.com/docs/web/setup#available-libraries

      // Your web app's Firebase configuration
      // For Firebase JS SDK v7.20.0 and later, measurementId is optional
      const firebaseConfig = {
      apiKey: "AIzaSyAho5ir0smsijET6nT78MuGAMKNUFyL6wE",
      authDomain: "budget-buddy-317d1.firebaseapp.com",
      projectId: "budget-buddy-317d1",
      storageBucket: "budget-buddy-317d1.appspot.com",
      messagingSenderId: "748761990865",
      appId: "1:748761990865:web:41f2db92b06dc8832427f0",
      measurementId: "G-9542ZL0LQ0"
      };

      // Initialize Firebase
      const app = initializeApp(firebaseConfig);
      const auth = getAuth();
      const db = getDatabase();

      var username = document.querySelector("#signinUsername");
      var password = document.querySelector("#signinPassword");

      signin.addEventListener("click", SignIn);

      function SignIn() {
        const dbref = ref(db);
        get(child(dbref, "People/" + username.value))
          .then((snapshot) => {
            let email = snapshot.val().Email;

            setPersistence(auth, browserSessionPersistence)
              .then(() => {
                // Existing and future Auth states are now persisted in the current
                // session only. Closing the window would clear any existing state even
                // if a user forgets to sign out.
                // ...
                // New sign-in will be persisted with session persistence.
                return signInWithEmailAndPassword(auth, email, password);
              })
              .catch((error) => {
                // Handle Errors here.
                const errorCode = error.code;
                const errorMessage = error.message;
              });

            signInWithEmailAndPassword(auth, email, password.value)
              .then((userCredential) => {
                // Signed in
                const user = userCredential.user;

                updateProfile(auth.currentUser, {
                  displayName: username.value,
                })
                  .then(() => {
                    // Profile updated!
                    // ...
                    window.location.replace("dashboard.html");
                  })
                  .catch((error) => {
                    // An error occurred
                    // ...
                  });

                // ...
              })
              .catch((error) => {
                const errorCode = error.code;
                const errorMessage = error.message;
                alert("Username or Password Incorrect");
              });
          })
          .catch((error) => {
            alert(error);
          });
      }
    </script>
  </body>
</html>
